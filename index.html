<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FurniCAD v0.2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg0:#070b0f; --bg1:#0c1118; --bg2:#111825; --bg3:#172030;
      --line:#1c2b3d; --line2:#253547;
      --text:#c8d8e8; --dim:#4e6880; --dim2:#627a91;
      --blue:#4a9cdc; --cyan:#00bfbc; --amber:#f0a020;
      --green:#38c46e; --red:#d95050; --purple:#8b6fe8;
      --code:#7dc8e3;
      --card:#0e1620;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'IBM Plex Sans',sans-serif;background:var(--bg0);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column;}
    ::-webkit-scrollbar{width:5px;height:5px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:var(--line2);border-radius:3px;}

    /* â”€â”€ HEADER â”€â”€ */
    header{height:42px;background:var(--bg1);border-bottom:1px solid var(--line);display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0;}
    .logo{font-family:'Space Mono',monospace;font-weight:700;font-size:14px;letter-spacing:1.5px;color:var(--cyan);}
    .logo em{color:var(--amber);font-style:normal;}
    .badge{font-family:'JetBrains Mono',monospace;font-size:9.5px;color:var(--dim);background:var(--bg3);border:1px solid var(--line);padding:2px 7px;border-radius:3px;}
    .hdr-stats{margin-left:auto;display:flex;gap:16px;}
    .hdr-stat{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);}
    .hdr-stat b{color:var(--blue);font-weight:600;}

    /* â”€â”€ WORKSPACE â”€â”€ */
    .workspace{display:flex;flex:1;overflow:hidden;}

    /* â”€â”€ EDITOR SIDE â”€â”€ */
    .editor-side{width:360px;min-width:260px;display:flex;flex-direction:column;background:var(--bg1);border-right:1px solid var(--line);flex-shrink:0;}
    .pane-label{height:32px;display:flex;align-items:center;padding:0 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);border-bottom:1px solid var(--line);gap:7px;}
    .pane-label::before{content:'';width:5px;height:5px;border-radius:50%;background:var(--cyan);opacity:.55;}

    #code{flex:1;background:var(--bg0);color:var(--code);border:none;outline:none;
      font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.72;
      padding:12px 14px;resize:none;tab-size:2;caret-color:var(--cyan);}
    #code::selection{background:#4d9de030;}

    .syntax-ref{border-top:1px solid var(--line);padding:9px 14px;flex-shrink:0;}
    .syntax-ref h4{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-bottom:7px;}
    .syn-row{font-size:10.5px;line-height:1.9;font-family:'JetBrains Mono',monospace;color:var(--dim2);}
    .syn-row .k{color:var(--blue);}
    .syn-row .v{color:var(--amber);}
    .syn-row .c{color:var(--dim);font-style:italic;}

    .editor-footer{height:28px;border-top:1px solid var(--line);display:flex;align-items:center;padding:0 14px;gap:12px;flex-shrink:0;
      font-family:'JetBrains Mono',monospace;font-size:10.5px;color:var(--dim);}
    #stat-boards{color:var(--green);font-weight:600;}

    /* â”€â”€ PREVIEW SIDE â”€â”€ */
    .preview-side{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

    .tabs{height:32px;background:var(--bg1);border-bottom:1px solid var(--line);display:flex;flex-shrink:0;}
    .tab{display:flex;align-items:center;gap:6px;padding:0 18px;font-size:11px;font-weight:600;cursor:pointer;color:var(--dim);border-bottom:2px solid transparent;transition:all .15s;user-select:none;letter-spacing:.2px;}
    .tab:hover{color:var(--text);}
    .tab.active{color:var(--cyan);border-bottom-color:var(--cyan);}

    /* 2D sub-toolbar */
    .sub-toolbar{height:34px;background:var(--bg2);border-bottom:1px solid var(--line);display:flex;align-items:center;padding:0 12px;gap:8px;flex-shrink:0;}
    .view-btn{display:flex;align-items:center;gap:5px;font-size:10.5px;font-weight:600;padding:4px 10px;border-radius:4px;border:1px solid var(--line);background:transparent;color:var(--dim);cursor:pointer;transition:all .15s;letter-spacing:.2px;}
    .view-btn:hover{color:var(--text);border-color:var(--line2);}
    .view-btn.active{background:var(--bg3);border-color:var(--cyan);color:var(--cyan);}
    .sub-sep{width:1px;height:20px;background:var(--line);margin:0 4px;}
    .sort-label{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.8px;margin-left:4px;}
    .sort-btn{font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 8px;border-radius:3px;border:1px solid var(--line);background:transparent;color:var(--dim);cursor:pointer;transition:all .15s;}
    .sort-btn:hover{color:var(--text);}
    .sort-btn.active{color:var(--amber);border-color:var(--amber);}

    /* views */
    .view{flex:1;display:none;overflow:hidden;position:relative;}
    .view.active{display:flex;flex-direction:column;}

    /* 2D assembled */
    #view-2d-assemble{flex:1;overflow:hidden;}
    #svg2d{width:100%;height:100%;}

    /* 2D list */
    #view-2d-list{flex:1;display:flex;overflow:hidden;}
    .list-sidebar{width:190px;min-width:150px;border-right:1px solid var(--line);background:var(--bg1);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
    .sidebar-header{height:32px;display:flex;align-items:center;padding:0 12px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);border-bottom:1px solid var(--line);gap:8px;}
    .sidebar-actions{display:flex;gap:5px;margin-left:auto;}
    .sidebar-action{font-size:9px;color:var(--dim);cursor:pointer;padding:2px 6px;border-radius:3px;border:1px solid var(--line);background:transparent;transition:all .15s;}
    .sidebar-action:hover{color:var(--cyan);border-color:var(--cyan);}
    .board-list{flex:1;overflow-y:auto;padding:6px;}
    .board-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:5px;cursor:pointer;transition:background .12s;border:1px solid transparent;margin-bottom:2px;}
    .board-item:hover{background:var(--bg3);}
    .board-item.selected{background:var(--bg3);border-color:var(--line2);}
    .board-item.hidden-board{opacity:.38;}
    .board-color{width:9px;height:9px;border-radius:2px;flex-shrink:0;}
    .board-info{flex:1;min-width:0;}
    .board-name{font-size:11px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .board-id{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);}
    .board-toggle{width:16px;height:16px;border-radius:3px;border:1px solid var(--line2);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .12s;}
    .board-toggle.on{background:var(--cyan);border-color:var(--cyan);}
    .board-toggle.on::after{content:'âœ“';font-size:9px;color:#000;}

    /* Main list canvas */
    .list-canvas{flex:1;overflow:auto;background:var(--bg0);}
    #svg-list{display:block;}

    /* 3D view */
    #view-3d{flex:1;}
    #canvas3d{width:100%;height:100%;display:block;cursor:grab;}
    #canvas3d:active{cursor:grabbing;}
    .hint-3d{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--dim);background:#07111acc;backdrop-filter:blur(4px);padding:4px 14px;border-radius:20px;border:1px solid var(--line);pointer-events:none;white-space:nowrap;}

    .error-bar{display:none;background:#150a0a;border-top:1px solid #3d1010;color:#e08080;padding:5px 14px;font-size:10.5px;font-family:'JetBrains Mono',monospace;flex-shrink:0;}
  </style>
</head>
<body>

<header>
  <div class="logo">Furni<em>CAD</em></div>
  <span class="badge">v0.2</span>
  <div class="hdr-stats">
    <span class="hdr-stat">Desky: <b id="hdr-count">0</b></span>
    <span class="hdr-stat">Plocha: <b id="hdr-area">â€”</b></span>
    <span class="hdr-stat">PromÄ›nnÃ©: <b id="hdr-vars">0</b></span>
  </div>
</header>

<div class="workspace">

  <!-- â”€â”€ EDITOR â”€â”€ -->
  <div class="editor-side">
    <div class="pane-label">DSL Editor</div>
    <textarea id="code" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
    <div class="syntax-ref">
      <h4>Syntaxe</h4>
      <div class="syn-row"><span class="k">$nÃ¡zev</span> = <span class="v">hodnota</span> &nbsp;<span class="c"># promÄ›nnÃ¡</span></div>
      <div class="syn-row"><span class="k">board</span>[<span class="v">id</span>] <span class="v">Å  x V x H</span> <span class="k">"nÃ¡zev"</span></div>
      <div class="syn-row">&nbsp;&nbsp; at <span class="v">X, Y, Z</span> &nbsp;<span class="c"># volitelnÃ©</span></div>
      <div class="syn-row">&nbsp;&nbsp; color <span class="v">#hex</span> &nbsp;<span class="c"># volitelnÃ©</span></div>
      <div class="syn-row" style="margin-top:4px;"><span class="c"># VÃ½razy: $var, {id.top}, {id.right}</span></div>
      <div class="syn-row"><span class="c"># Vlastnosti: .x .y .z .right .top .back .w .h .d</span></div>
    </div>
    <div class="editor-footer">
      <span id="stat-boards">0 desek</span>
      <span id="stat-area"></span>
      <span id="stat-vars"></span>
    </div>
  </div>

  <!-- â”€â”€ PREVIEW â”€â”€ -->
  <div class="preview-side">
    <div class="tabs">
      <div class="tab active" data-tab="2d">â—« &nbsp;2D pohled</div>
      <div class="tab" data-tab="3d">â—ˆ &nbsp;3D nÃ¡hled</div>
    </div>

    <!-- 2D view container -->
    <div class="view active" id="view-2d">
      <div class="sub-toolbar">
        <button class="view-btn active" id="btn-assemble">â¬› Sestaveno</button>
        <button class="view-btn" id="btn-list">â‰¡ Seznam desek</button>
        <div class="sub-sep" id="sort-sep" style="display:none;"></div>
        <span class="sort-label" id="sort-lbl" style="display:none;">Å˜adit:</span>
        <button class="sort-btn active" id="sort-name" style="display:none;" data-sort="name">NÃ¡zev</button>
        <button class="sort-btn" id="sort-w" style="display:none;" data-sort="w">Å Ã­Å™ka â†“</button>
        <button class="sort-btn" id="sort-h" style="display:none;" data-sort="h">VÃ½Å¡ka â†“</button>
        <button class="sort-btn" id="sort-area" style="display:none;" data-sort="area">Plocha â†“</button>
      </div>

      <!-- Assembled -->
      <div id="view-2d-assemble" class="active" style="display:block;flex:1;overflow:hidden;">
        <svg id="svg2d" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>

      <!-- List -->
      <div id="view-2d-list" style="display:none;flex:1;">
        <div class="list-sidebar">
          <div class="sidebar-header">
            Desky
            <div class="sidebar-actions">
              <button class="sidebar-action" id="btn-all">VÅ¡e</button>
              <button class="sidebar-action" id="btn-none">Å½Ã¡dnÃ©</button>
            </div>
          </div>
          <div class="board-list" id="board-list-el"></div>
        </div>
        <div class="list-canvas" id="list-canvas-wrap">
          <svg id="svg-list" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
    </div>

    <!-- 3D view -->
    <div class="view" id="view-3d">
      <canvas id="canvas3d"></canvas>
      <div class="hint-3d">ğŸ–± TaÅ¾enÃ­m rotuj Â· KoleÄkem pÅ™ibliÅ¾</div>
    </div>

    <div class="error-bar" id="error-bar"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFAULT CODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_CODE = `# SkÅ™Ã­Åˆka 80 Ã— 40 Ã— 200 cm
# â”€â”€ PromÄ›nnÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$T  = 18        # tlouÅ¡Å¥ka desky [mm]
$W  = 800       # vnÄ›jÅ¡Ã­ Å¡Ã­Å™ka
$H  = 2000      # vnÄ›jÅ¡Ã­ vÃ½Å¡ka
$D  = 400       # hloubka

# â”€â”€ Desky â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
board[dn]     $W x $T x $D    "Dno"         at 0, 0, 0              color #7a4f28
board[lt]     $T x $H x $D    "LevÃ½ bok"    at 0, 0, 0              color #9a6235
board[rt]     $T x $H x $D    "PravÃ½ bok"   at {lt.right}+$W, 0, 0  color #9a6235
board[tp]     $W+{lt.w} x $T x $D "Strop"  at {lt.x}, {lt.top}-$T, 0  color #7a4f28
board[bk]     {lt.right}+$W x $H x $T "ZÃ¡da" at {lt.x}, {lt.y}, $D-$T  color #5c3a1e
board[p1]     $W x $T x $D-$T  "Police 1"  at {lt.right}, {dn.top}+380, {dn.z}    color #c49a6c
board[p2]     $W x $T x $D-$T  "Police 2"  at {p1.x}, {p1.top}+380, {p1.z}       color #c49a6c
board[p3]     $W x $T x $D-$T  "Police 3"  at {p2.x}, {p2.top}+380, {p2.z}       color #c49a6c`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AUTO_COLORS = [
  '#c9a05a','#b8864a','#d4b87a','#a07040',
  '#e8c99a','#8b6035','#daa060','#c08040',
  '#7a6050','#d4a080','#b09070','#9a7055',
];

class DSLParser {
  constructor(text) {
    this.text = text;
    this.vars = {};
    this.boards = [];
    this.errors = [];
    this.reg = {};
    this.varCount = 0;
  }

  parse() {
    const lines = this.text.split('\n');
    for (let i = 0; i < lines.length; i++) {
      const raw = lines[i];
      const line = raw.trim();
      if (!line || line.startsWith('#') || line.startsWith('//')) continue;
      if (line.startsWith('$')) { this.parseVar(line, i+1); continue; }
      if (/^board/i.test(line))  { this.parseBoard(line, i+1); continue; }
      this.errors.push(`Å˜Ã¡dek ${i+1}: neznÃ¡mÃ½ pÅ™Ã­kaz`);
    }
    return { boards: this.boards, errors: this.errors, varCount: this.varCount };
  }

  parseVar(line, ln) {
    const m = line.match(/^\$([a-zA-Z_]\w*)\s*=\s*(.+?)(?:\s*#.*)?$/);
    if (!m) { this.errors.push(`Å˜Ã¡dek ${ln}: neplatnÃ¡ definice promÄ›nnÃ©`); return; }
    try {
      this.vars[m[1]] = this.eval(m[2].trim());
      this.varCount++;
    } catch(e) { this.errors.push(`Å˜Ã¡dek ${ln} ($${m[1]}): ${e.message}`); }
  }

  parseBoard(line, ln) {
    // board[id]  W x H x D  "name"  [at X, Y, Z]  [color #hex]
    // Capture everything after the optional [id] and dimensions until "name"
    const re = /^board(?:\[([a-zA-Z_]\w*)\])?\s+(.+?)\s+"([^"]+)"(?:\s+at\s+(.+?))?(?:\s+color\s+(#[0-9a-fA-F]{3,6}))?\s*(?:#.*)?$/i;
    const m = line.match(re);
    if (!m) { this.errors.push(`Å˜Ã¡dek ${ln}: neplatnÃ½ board (vzor: board[id] Å xVxH "nÃ¡zev")`); return; }

    const id    = m[1] || `b${this.boards.length}`;
    const dimRaw= m[2].trim();
    const name  = m[3];
    const atRaw = m[4] ? m[4].trim() : null;
    const color = m[5] || AUTO_COLORS[this.boards.length % AUTO_COLORS.length];

    if (this.reg[id]) { this.errors.push(`Å˜Ã¡dek ${ln}: duplicitnÃ­ ID [${id}]`); return; }

    try {
      // Split dimensions on 'x' that sits between value-like tokens
      const dims = dimRaw.split(/\s*[xXÑ…]\s*(?=[0-9$({])/);
      if (dims.length !== 3) throw new Error(`PotÅ™ebuji 3 rozmÄ›ry (Å  x V x H), dostal jsem ${dims.length}: "${dimRaw}"`);
      const w = this.eval(dims[0].trim());
      const h = this.eval(dims[1].trim());
      const d = this.eval(dims[2].trim());

      let x=null, y=null, z=null, hasPos=false;
      if (atRaw) {
        const coords = this.splitCoords(atRaw);
        if (coords.length !== 3) throw new Error(`Pozice potÅ™ebuje 3 hodnoty (X, Y, Z)`);
        x = this.eval(coords[0].trim());
        y = this.eval(coords[1].trim());
        z = this.eval(coords[2].trim());
        hasPos = true;
      }

      const board = { id, name, w, h, d, x, y, z, hasPos, color, visible: true };
      this.boards.push(board);
      this.reg[id] = board;
    } catch(e) {
      this.errors.push(`Å˜Ã¡dek ${ln} (${name}): ${e.message}`);
    }
  }

  // Split coords: X, Y, Z â€” but respect nested braces
  splitCoords(str) {
    const parts = []; let depth = 0; let cur = '';
    for (const ch of str) {
      if (ch === '{' || ch === '(') depth++;
      else if (ch === '}' || ch === ')') depth--;
      if (ch === ',' && depth === 0) { parts.push(cur); cur = ''; }
      else cur += ch;
    }
    parts.push(cur);
    return parts;
  }

  eval(expr) {
    // 1. Replace $var
    let e = String(expr).replace(/\$([a-zA-Z_]\w*)/g, (_, n) => {
      if (this.vars[n] !== undefined) return this.vars[n];
      throw new Error(`NeznÃ¡mÃ¡ promÄ›nnÃ¡ $${n}`);
    });
    // 2. Replace {id.prop}
    e = e.replace(/\{([a-zA-Z_]\w*)\.([a-zA-Z]+)\}/g, (_, id, prop) => {
      const b = this.reg[id];
      if (!b) throw new Error(`NeznÃ¡mÃ© ID [${id}]`);
      return this.prop(b, prop, id);
    });
    // 3. Safe math
    return this.math(e);
  }

  prop(b, p, id) {
    const x=b.x??0, y=b.y??0, z=b.z??0;
    switch(p) {
      case 'x': return x; case 'y': return y; case 'z': return z;
      case 'w': return b.w; case 'h': return b.h; case 'd': return b.d;
      case 'right': return x+b.w; case 'top': return y+b.h; case 'back': return z+b.d;
      case 'cx': return x+b.w/2; case 'cy': return y+b.h/2;
    }
    throw new Error(`NeznÃ¡mÃ¡ vlastnost .${p} na [${id}]`);
  }

  math(expr) {
    const e = String(expr).trim();
    if (!/^[\d\s\+\-\*\/\(\)\.]+$/.test(e))
      throw new Error(`NeplatnÃ½ vÃ½raz: "${e}" (povoleny: ÄÃ­sla, +,-,*,/,()`);
    try {
      const r = Function(`"use strict";return (${e})`)();
      if (typeof r !== 'number' || !isFinite(r)) throw new Error('VÃ½sledek nenÃ­ ÄÃ­slo');
      return Math.round(r * 1000) / 1000;
    } catch(err) { throw new Error(`Chyba vÃ½razu "${e}"`); }
  }
}

function parseDSL(text) {
  return new DSLParser(text).parse();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function svgEl(tag, attrs={}, text='') {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (const [k,v] of Object.entries(attrs)) el.setAttribute(k,v);
  if (text) el.textContent = text;
  return el;
}
function darken(hex, f=0.5) {
  if (!hex||hex.length<7) return '#333';
  const r=(parseInt(hex.slice(1,3),16)*f|0).toString(16).padStart(2,'0');
  const g=(parseInt(hex.slice(3,5),16)*f|0).toString(16).padStart(2,'0');
  const b=(parseInt(hex.slice(5,7),16)*f|0).toString(16).padStart(2,'0');
  return `#${r}${g}${b}`;
}
function boardCount(n) {
  if(n===0) return '0 desek'; if(n===1) return '1 deska';
  if(n<5) return `${n} desky`; return `${n} desek`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  2D ASSEMBLED VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render2DAssemble(boards) {
  const svg = document.getElementById('svg2d');
  const W = svg.clientWidth||800, H = svg.clientHeight||600;
  svg.innerHTML = '';
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  svg.appendChild(svgEl('rect',{x:0,y:0,width:W,height:H,fill:'#070b0f'}));

  if (!boards.length) {
    svg.appendChild(svgEl('text',{x:W/2,y:H/2-8,fill:'#1c2b3d','text-anchor':'middle','font-size':40,'font-family':'monospace'},'â—«'));
    svg.appendChild(svgEl('text',{x:W/2,y:H/2+24,fill:'#1c3a5c','text-anchor':'middle','font-size':13,'font-family':'IBM Plex Sans,sans-serif'},'NapiÅ¡te desky...'));
    return;
  }

  const vis = boards.filter(b=>b.visible!==false);
  if (!vis.length) return;

  const allPos = vis.every(b=>b.hasPos&&b.x!==null);
  let layout;
  if (allPos) {
    layout = vis.map(b=>({...b,lx:b.x,ly:b.y}));
  } else {
    let cx=0; layout = vis.map(b=>{const l={...b,lx:cx,ly:0};cx+=b.w+20;return l;});
  }

  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  for (const b of layout) {
    minX=Math.min(minX,b.lx); minY=Math.min(minY,b.ly);
    maxX=Math.max(maxX,b.lx+b.w); maxY=Math.max(maxY,b.ly+b.h);
  }

  const PAD=70;
  const scale=Math.min((W-PAD*2)/(maxX-minX||1),(H-PAD*2)/(maxY-minY||1))*0.86;
  const tw=(maxX-minX)*scale, th=(maxY-minY)*scale;
  const offX=(W-tw)/2-minX*scale, offY=(H-th)/2;

  const tx=wx=>wx*scale+offX;
  const ty=wy=>(maxY-wy)*scale+offY;

  // Grid
  for (let gx=0;gx<=W;gx+=40) svg.appendChild(svgEl('line',{x1:gx,y1:0,x2:gx,y2:H,stroke:'#1c2b3d','stroke-width':.5}));
  for (let gy=0;gy<=H;gy+=40) svg.appendChild(svgEl('line',{x1:0,y1:gy,x2:W,y2:gy,stroke:'#1c2b3d','stroke-width':.5}));

  for (const b of layout) {
    const bx=tx(b.lx),by=ty(b.ly+b.h),bw=b.w*scale,bh=b.h*scale;
    svg.appendChild(svgEl('rect',{x:bx+3,y:by+3,width:bw,height:bh,fill:'#00000044',rx:2}));
    svg.appendChild(svgEl('rect',{x:bx,y:by,width:bw,height:bh,fill:b.color,stroke:darken(b.color,.45),'stroke-width':1,rx:2}));
    // grain
    const gc=Math.min(6,Math.floor(bw/25));
    for(let i=1;i<=gc;i++){
      const gx=bx+(bw/(gc+1))*i;
      svg.appendChild(svgEl('line',{x1:gx,y1:by+2,x2:gx,y2:by+bh-2,stroke:'#ffffff0f','stroke-width':.8}));
    }
    // text
    const fs=Math.max(8,Math.min(11,bw/Math.max(b.name.length,3)*1.3));
    if (bw>24&&bh>14) {
      svg.appendChild(svgEl('text',{x:bx+bw/2,y:by+bh/2-(bh>28?fs*.45:0),fill:'#ffffffcc','text-anchor':'middle','dominant-baseline':'middle','font-size':fs,'font-family':'IBM Plex Sans,sans-serif','font-weight':'600'},b.name));
    }
    if (bh>28&&bw>36) {
      svg.appendChild(svgEl('text',{x:bx+bw/2,y:by+bh/2+fs*.85,fill:'#ffffff55','text-anchor':'middle','dominant-baseline':'middle','font-size':Math.max(7,fs-2.5),'font-family':'JetBrains Mono,monospace'},`[${b.id}]`));
    }
    if (bw>28) drawDimH(svg,bx,bx+bw,by+bh+11,`${b.w}`);
    if (bh>16) drawDimV(svg,bx-11,by,by+bh,`${b.h}`);
  }

  // Axis labels
  svg.appendChild(svgEl('text',{fill:'#4e6880','font-size':9,'font-family':'JetBrains Mono,monospace',x:W-10,y:H/2,'text-anchor':'end'},'â†’ X'));
  svg.appendChild(svgEl('text',{fill:'#4e6880','font-size':9,'font-family':'JetBrains Mono,monospace',x:8,y:14},'â†‘ Y'));
}

function drawDimH(svg,x1,x2,y,lbl){
  svg.appendChild(svgEl('line',{x1,y1:y,x2,y2:y,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('line',{x1,y1:y-3,x2:x1,y2:y+3,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('line',{x1:x2,y1:y-3,x2,y2:y+3,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('text',{x:(x1+x2)/2,y:y+10,fill:'#4a9cdcaa','text-anchor':'middle','font-size':8,'font-family':'JetBrains Mono,monospace'},lbl));
}
function drawDimV(svg,x,y1,y2,lbl){
  svg.appendChild(svgEl('line',{x1:x,y1,x2:x,y2,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('line',{x1:x-3,y1,x2:x+3,y2:y1,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('line',{x1:x-3,y1:y2,x2:x+3,y2,stroke:'#4a9cdc55','stroke-width':.8}));
  const mid=(y1+y2)/2;
  const t=svgEl('text',{x:x-2,y:mid,fill:'#4a9cdcaa','text-anchor':'middle','font-size':8,'font-family':'JetBrains Mono,monospace',transform:`rotate(-90,${x-2},${mid})`},lbl);
  svg.appendChild(t);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  2D LIST VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedBoardId = null;
let sortMode = 'name';
let boardVisibility = {}; // id -> bool

function renderBoardSidebar(boards) {
  const el = document.getElementById('board-list-el');
  el.innerHTML = '';
  let sorted = [...boards];
  if (sortMode==='name')  sorted.sort((a,b)=>a.name.localeCompare(b.name));
  if (sortMode==='w')     sorted.sort((a,b)=>b.w-a.w);
  if (sortMode==='h')     sorted.sort((a,b)=>b.h-a.h);
  if (sortMode==='area')  sorted.sort((a,b)=>(b.w*b.h)-(a.w*a.h));

  for (const b of sorted) {
    const vis = boardVisibility[b.id] !== false;
    const item = document.createElement('div');
    item.className = 'board-item' + (b.id===selectedBoardId?' selected':'') + (!vis?' hidden-board':'');
    item.dataset.id = b.id;

    const colorDot = document.createElement('div');
    colorDot.className = 'board-color';
    colorDot.style.background = b.color;

    const info = document.createElement('div');
    info.className = 'board-info';
    info.innerHTML = `<div class="board-name">${b.name}</div><div class="board-id">[${b.id}] &nbsp;${b.w}Ã—${b.h}Ã—${b.d}</div>`;

    const toggle = document.createElement('div');
    toggle.className = 'board-toggle' + (vis?' on':'');
    toggle.onclick = (e) => {
      e.stopPropagation();
      boardVisibility[b.id] = !vis;
      renderListView(window._lastBoards);
    };

    item.onclick = () => {
      selectedBoardId = b.id;
      renderListView(window._lastBoards);
      scrollToBoard(b.id);
    };

    item.appendChild(colorDot);
    item.appendChild(info);
    item.appendChild(toggle);
    el.appendChild(item);
  }
}

function scrollToBoard(id) {
  const el = document.getElementById('card-'+id);
  if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
}

function renderListSVG(boards) {
  const svg = document.getElementById('svg-list');
  const container = document.getElementById('list-canvas-wrap');
  const CW = container.clientWidth || 600;

  svg.innerHTML = '';

  const visible = boards.filter(b => boardVisibility[b.id] !== false);
  let sorted = [...visible];
  if (sortMode==='name')  sorted.sort((a,b)=>a.name.localeCompare(b.name));
  if (sortMode==='w')     sorted.sort((a,b)=>b.w-a.w);
  if (sortMode==='h')     sorted.sort((a,b)=>b.h-a.h);
  if (sortMode==='area')  sorted.sort((a,b)=>(b.w*b.h)-(a.w*a.h));

  if (!sorted.length) {
    svg.setAttribute('width', CW); svg.setAttribute('height', 200);
    svg.appendChild(svgEl('text',{x:CW/2,y:100,fill:'#1c3a5c','text-anchor':'middle','font-size':13,'font-family':'IBM Plex Sans,sans-serif'},'Å½Ã¡dnÃ© viditelnÃ© desky'));
    return;
  }

  const ROW_H = 140;
  const PAD_X = 80;
  const PAD_Y_TOP = 20;
  const maxW = sorted.reduce((m,b)=>Math.max(m,b.w),0);
  const maxH = sorted.reduce((m,b)=>Math.max(m,b.h),0);

  // Available width for board rect
  const availW = CW - PAD_X * 2 - 180; // 180 for info on right
  const availH = ROW_H - 36;

  const totalSVGH = PAD_Y_TOP + sorted.length * (ROW_H + 4) + 20;
  svg.setAttribute('width', CW);
  svg.setAttribute('height', totalSVGH);
  svg.appendChild(svgEl('rect',{x:0,y:0,width:CW,height:totalSVGH,fill:'#070b0f'}));

  for (let i=0; i<sorted.length; i++) {
    const b = sorted[i];
    const ry = PAD_Y_TOP + i*(ROW_H+4);
    const isSelected = b.id === selectedBoardId;

    // Row bg
    const rowBg = svgEl('rect',{x:8,y:ry,width:CW-16,height:ROW_H,fill:isSelected?'#0e1e2e':'#0b1520',rx:6,
      stroke:isSelected?'#253547':'#111e2c','stroke-width':1});
    svg.appendChild(rowBg);

    // Board number label
    svg.appendChild(svgEl('text',{x:18,y:ry+18,fill:'#253547','font-size':10,'font-family':'JetBrains Mono,monospace',
      'font-weight':'600'},(i+1).toString().padStart(2,'0')));

    // --- Scale board rect ---
    const scaleX = availW / b.w;
    const scaleH = availH / b.h;
    const bscale = Math.min(scaleX, scaleH, 0.5); // cap at 0.5 (1px = 2mm)

    const bw = b.w * bscale;
    const bh = b.h * bscale;

    const bx = PAD_X + (availW - bw) / 2;
    const by = ry + (ROW_H - bh) / 2;

    // Shadow
    svg.appendChild(svgEl('rect',{x:bx+3,y:by+3,width:bw,height:bh,fill:'#00000044',rx:2}));
    // Board
    svg.appendChild(svgEl('rect',{x:bx,y:by,width:bw,height:bh,fill:b.color,stroke:darken(b.color,.4),'stroke-width':1,rx:2,
      id:'card-'+b.id}));
    // Grain
    const gc=Math.min(7,Math.floor(bw/20));
    for(let g=1;g<=gc;g++){
      const gx=bx+(bw/(gc+1))*g;
      svg.appendChild(svgEl('line',{x1:gx,y1:by+2,x2:gx,y2:by+bh-2,stroke:'#ffffff0e','stroke-width':.7}));
    }

    // Width dim (below)
    const dimY = by+bh+10;
    svg.appendChild(svgEl('line',{x1:bx,y1:dimY,x2:bx+bw,y2:dimY,stroke:'#4a9cdc44','stroke-width':.8}));
    svg.appendChild(svgEl('line',{x1:bx,y1:dimY-3,x2:bx,y2:dimY+3,stroke:'#4a9cdc44','stroke-width':.8}));
    svg.appendChild(svgEl('line',{x1:bx+bw,y1:dimY-3,x2:bx+bw,y2:dimY+3,stroke:'#4a9cdc44','stroke-width':.8}));
    svg.appendChild(svgEl('text',{x:bx+bw/2,y:dimY+10,fill:'#4a9cdc99','text-anchor':'middle','font-size':8.5,'font-family':'JetBrains Mono,monospace'},`${b.w} mm`));

    // Height dim (left)
    const dimX = bx - 10;
    svg.appendChild(svgEl('line',{x1:dimX,y1:by,x2:dimX,y2:by+bh,stroke:'#4a9cdc44','stroke-width':.8}));
    svg.appendChild(svgEl('line',{x1:dimX-3,y1:by,x2:dimX+3,y2:by,stroke:'#4a9cdc44','stroke-width':.8}));
    svg.appendChild(svgEl('line',{x1:dimX-3,y1:by+bh,x2:dimX+3,y2:by+bh,stroke:'#4a9cdc44','stroke-width':.8}));
    const midY=by+bh/2;
    svg.appendChild(svgEl('text',{x:dimX-3,y:midY,fill:'#4a9cdc99','text-anchor':'middle','font-size':8.5,'font-family':'JetBrains Mono,monospace',transform:`rotate(-90,${dimX-3},${midY})`},`${b.h} mm`));

    // --- Info panel (right) ---
    const ix = bx + bw + 28;
    const iy = ry + 22;
    // Name
    svg.appendChild(svgEl('text',{x:ix,y:iy,fill:'#c8d8e8','font-size':13,'font-family':'IBM Plex Sans,sans-serif','font-weight':'600'},b.name));
    // ID
    svg.appendChild(svgEl('text',{x:ix,y:iy+18,fill:'#4e6880','font-size':10,'font-family':'JetBrains Mono,monospace'},`[${b.id}]`));
    // Dims
    svg.appendChild(svgEl('text',{x:ix,y:iy+38,fill:'#8fa8c0','font-size':10.5,'font-family':'JetBrains Mono,monospace'},`Å : ${b.w} mm`));
    svg.appendChild(svgEl('text',{x:ix,y:iy+54,fill:'#8fa8c0','font-size':10.5,'font-family':'JetBrains Mono,monospace'},`V: ${b.h} mm`));
    svg.appendChild(svgEl('text',{x:ix,y:iy+70,fill:'#8fa8c0','font-size':10.5,'font-family':'JetBrains Mono,monospace'},`H: ${b.d} mm`));
    // Area
    const area = (b.w * b.h / 1e6).toFixed(4);
    svg.appendChild(svgEl('text',{x:ix,y:iy+88,fill:'#f0a02099','font-size':10,'font-family':'JetBrains Mono,monospace'},`${area} mÂ²`));

    // Position (if set)
    if (b.hasPos) {
      svg.appendChild(svgEl('text',{x:ix,y:iy+106,fill:'#38c46e77','font-size':9.5,'font-family':'JetBrains Mono,monospace'},`at (${b.x}, ${b.y}, ${b.z})`));
    }
  }
}

function renderListView(boards) {
  renderBoardSidebar(boards);
  renderListSVG(boards);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  3D RENDERER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scene3,cam3,ren3,grp3,initialized3=false;
let camT=0.7,camP=0.5,camR=4000,camTarget=new THREE.Vector3();
let mDrag=false,mPrev={x:0,y:0};

function init3D(){
  const canvas=document.getElementById('canvas3d');
  const W=canvas.offsetWidth||800,H=canvas.offsetHeight||600;
  scene3=new THREE.Scene();
  scene3.background=new THREE.Color(0x070b0f);
  scene3.fog=new THREE.FogExp2(0x070b0f,0.00007);
  cam3=new THREE.PerspectiveCamera(40,W/H,1,80000);
  updateCam3();
  ren3=new THREE.WebGLRenderer({canvas,antialias:true});
  ren3.setSize(W,H); ren3.setPixelRatio(Math.min(window.devicePixelRatio,2));
  ren3.shadowMap.enabled=true; ren3.shadowMap.type=THREE.PCFSoftShadowMap;

  scene3.add(new THREE.AmbientLight(0x506070,0.9));
  const sun=new THREE.DirectionalLight(0xfff5e0,1.1);
  sun.position.set(3000,5000,2000); sun.castShadow=true;
  sun.shadow.mapSize.width=sun.shadow.mapSize.height=2048;
  ['left','right','top','bottom'].forEach(s=>sun.shadow.camera[s]=s==='top'||s==='right'?4000:-4000);
  sun.shadow.camera.near=10; sun.shadow.camera.far=20000;
  scene3.add(sun);
  const fill=new THREE.DirectionalLight(0x304870,0.4); fill.position.set(-2000,800,-1500); scene3.add(fill);

  const grid=new THREE.GridHelper(8000,40,0x1c2b3d,0x111825);
  grid.position.y=-1; scene3.add(grid);
  const gnd=new THREE.Mesh(new THREE.PlaneGeometry(10000,10000),new THREE.ShadowMaterial({opacity:.18}));
  gnd.rotation.x=-Math.PI/2; gnd.receiveShadow=true; scene3.add(gnd);

  grp3=new THREE.Group(); scene3.add(grp3);
  scene3.add(new THREE.AxesHelper(150));

  canvas.addEventListener('mousedown',e=>{mDrag=true;mPrev={x:e.clientX,y:e.clientY};});
  window.addEventListener('mouseup',()=>mDrag=false);
  canvas.addEventListener('mousemove',e=>{
    if(!mDrag)return;
    camT-=(e.clientX-mPrev.x)*0.008;
    camP=Math.max(0.05,Math.min(1.52,camP-(e.clientY-mPrev.y)*0.007));
    mPrev={x:e.clientX,y:e.clientY}; updateCam3();
  });
  canvas.addEventListener('wheel',e=>{
    camR=Math.max(200,Math.min(25000,camR*(1+e.deltaY*0.001)));
    updateCam3(); e.preventDefault();
  },{passive:false});

  initialized3=true;
  (function loop(){requestAnimationFrame(loop);ren3.render(scene3,cam3);})();
}

function updateCam3(){
  const x=camR*Math.sin(camP)*Math.sin(camT);
  const y=camR*Math.cos(camP);
  const z=camR*Math.sin(camP)*Math.cos(camT);
  cam3.position.set(camTarget.x+x,camTarget.y+y,camTarget.z+z);
  cam3.lookAt(camTarget);
}

function render3D(boards){
  if(!grp3)return;
  while(grp3.children.length){const c=grp3.children[0];c.geometry?.dispose();c.material?.dispose();grp3.remove(c);}
  if(!boards.length)return;

  const allPos=boards.every(b=>b.hasPos&&b.x!==null);
  let ax=0;
  let cx=0,cy=0,cz=0,maxDim=0;

  for(const b of boards){
    let bx=allPos?(b.x??0):ax;
    let by=allPos?(b.y??0):0;
    let bz=allPos?(b.z??0):0;
    if(!allPos) ax+=b.w+20;

    const geo=new THREE.BoxGeometry(b.w,b.h,b.d);
    let col;
    try{col=new THREE.Color(b.color);}catch{col=new THREE.Color(0xb08050);}
    const mesh=new THREE.Mesh(geo,new THREE.MeshLambertMaterial({color:col}));
    mesh.position.set(bx+b.w/2,by+b.h/2,bz+b.d/2);
    mesh.castShadow=true; mesh.receiveShadow=true;
    const edgeMat=new THREE.LineBasicMaterial({color:new THREE.Color(b.color).multiplyScalar(0.35),transparent:true,opacity:.85});
    mesh.add(new THREE.LineSegments(new THREE.EdgesGeometry(geo),edgeMat));
    grp3.add(mesh);

    cx+=bx+b.w/2; cy+=by+b.h/2; cz+=bz+b.d/2;
    maxDim=Math.max(maxDim,bx+b.w,by+b.h,bz+b.d);
  }

  const n=boards.length;
  camTarget.set(cx/n,cy/n,cz/n);
  camR=maxDim*2.1;
  updateCam3();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentTab='2d';
let current2DMode='assemble';
let debTimer;

function update(){
  const text=document.getElementById('code').value;
  const {boards,errors,varCount}=parseDSL(text);
  window._lastBoards=boards;

  // Init visibility for new boards
  for(const b of boards) if(boardVisibility[b.id]===undefined) boardVisibility[b.id]=true;

  // Apply visibility
  const visBoards = boards.map(b=>({...b,visible:boardVisibility[b.id]!==false}));

  // Errors
  const eb=document.getElementById('error-bar');
  eb.style.display=errors.length?'block':'none';
  eb.textContent=errors.length?'âš   '+errors.join('  Â·  '):'';

  // Stats
  const n=boards.length;
  const area=boards.reduce((s,b)=>s+b.w*b.h/1e6,0);
  document.getElementById('stat-boards').textContent=boardCount(n);
  document.getElementById('stat-area').textContent=area>0?area.toFixed(3)+' mÂ²':'';
  document.getElementById('stat-vars').textContent=varCount>0?`${varCount} var`:'';
  document.getElementById('hdr-count').textContent=n;
  document.getElementById('hdr-area').textContent=area>0?area.toFixed(3)+' mÂ²':'â€”';
  document.getElementById('hdr-vars').textContent=varCount;

  // Render
  if(currentTab==='2d'){
    if(current2DMode==='assemble') render2DAssemble(visBoards);
    else renderListView(boards);
  } else if(currentTab==='3d'&&initialized3){
    render3D(visBoards.filter(b=>b.visible!==false));
  }
}

function debouncedUpdate(){clearTimeout(debTimer);debTimer=setTimeout(update,220);}

// â”€â”€ TABS â”€â”€
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    tab.classList.add('active');
    currentTab=tab.dataset.tab;
    document.getElementById(`view-${currentTab}`).classList.add('active');
    const {boards}=parseDSL(document.getElementById('code').value);
    window._lastBoards=boards;
    if(currentTab==='3d'){
      if(!initialized3) requestAnimationFrame(()=>{init3D();render3D(boards);});
      else render3D(boards);
    } else { requestAnimationFrame(()=>update()); }
  });
});

// â”€â”€ 2D SUB-TOOLBAR â”€â”€
document.getElementById('btn-assemble').addEventListener('click',()=>{
  current2DMode='assemble';
  document.getElementById('btn-assemble').classList.add('active');
  document.getElementById('btn-list').classList.remove('active');
  document.getElementById('view-2d-assemble').style.display='block';
  document.getElementById('view-2d-list').style.display='none';
  ['sort-sep','sort-lbl','sort-name','sort-w','sort-h','sort-area'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
  update();
});

document.getElementById('btn-list').addEventListener('click',()=>{
  current2DMode='list';
  document.getElementById('btn-list').classList.add('active');
  document.getElementById('btn-assemble').classList.remove('active');
  document.getElementById('view-2d-assemble').style.display='none';
  document.getElementById('view-2d-list').style.display='flex';
  ['sort-sep','sort-lbl','sort-name','sort-w','sort-h','sort-area'].forEach(id=>{
    document.getElementById(id).style.display='';
  });
  update();
});

// Sort buttons
['sort-name','sort-w','sort-h','sort-area'].forEach(btnId=>{
  document.getElementById(btnId).addEventListener('click',()=>{
    sortMode=document.getElementById(btnId).dataset.sort;
    ['sort-name','sort-w','sort-h','sort-area'].forEach(id=>document.getElementById(id).classList.remove('active'));
    document.getElementById(btnId).classList.add('active');
    if(current2DMode==='list') renderListView(window._lastBoards||[]);
  });
});

// Sidebar all/none
document.getElementById('btn-all').addEventListener('click',()=>{
  (window._lastBoards||[]).forEach(b=>{boardVisibility[b.id]=true;});
  renderListView(window._lastBoards||[]);
});
document.getElementById('btn-none').addEventListener('click',()=>{
  (window._lastBoards||[]).forEach(b=>{boardVisibility[b.id]=false;});
  renderListView(window._lastBoards||[]);
});

// Resize
window.addEventListener('resize',()=>{
  if(currentTab==='2d'){
    const {boards}=parseDSL(document.getElementById('code').value);
    const vis=boards.map(b=>({...b,visible:boardVisibility[b.id]!==false}));
    if(current2DMode==='assemble') render2DAssemble(vis);
    else renderListSVG(boards);
  }
  if(initialized3&&ren3){
    const c=document.getElementById('canvas3d');
    if(c.offsetWidth>0){ren3.setSize(c.offsetWidth,c.offsetHeight);cam3.aspect=c.offsetWidth/c.offsetHeight;cam3.updateProjectionMatrix();}
  }
});

// â”€â”€ INIT â”€â”€
document.getElementById('code').value=DEFAULT_CODE;
document.getElementById('code').addEventListener('input',debouncedUpdate);
update();
</script>
</body>
</html>
