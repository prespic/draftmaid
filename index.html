<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DraftMaid v0.2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="lib/engine.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg0:#070b0f; --bg1:#0c1118; --bg2:#111825; --bg3:#172030;
      --line:#1c2b3d; --line2:#253547;
      --text:#c8d8e8; --dim:#4e6880; --dim2:#627a91;
      --blue:#4a9cdc; --cyan:#00bfbc; --amber:#f0a020;
      --green:#38c46e; --red:#d95050; --purple:#8b6fe8;
      --code:#7dc8e3;
      --card:#0e1620;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'IBM Plex Sans',sans-serif;background:var(--bg0);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column;}
    ::-webkit-scrollbar{width:5px;height:5px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:var(--line2);border-radius:3px;}

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header{height:42px;background:var(--bg1);border-bottom:1px solid var(--line);display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0;}
    .logo{font-family:'Space Mono',monospace;font-weight:700;font-size:14px;letter-spacing:1.5px;color:var(--cyan);}
    .logo em{color:var(--amber);font-style:normal;}
    .badge{font-family:'JetBrains Mono',monospace;font-size:9.5px;color:var(--dim);background:var(--bg3);border:1px solid var(--line);padding:2px 7px;border-radius:3px;}
    .hdr-stats{margin-left:auto;display:flex;gap:16px;}
    .hdr-stat{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);}
    .hdr-stat b{color:var(--blue);font-weight:600;}

    #example-select{font-family:'JetBrains Mono',monospace;font-size:10.5px;color:var(--text);background:var(--bg3);border:1px solid var(--line);border-radius:3px;padding:2px 6px;height:26px;cursor:pointer;outline:none;}
    #example-select:hover{border-color:var(--cyan);}
    #example-select:focus{border-color:var(--cyan);}

    /* ‚îÄ‚îÄ WORKSPACE ‚îÄ‚îÄ */
    .workspace{display:flex;flex:1;overflow:hidden;}

    /* ‚îÄ‚îÄ EDITOR SIDE ‚îÄ‚îÄ */
    .editor-side{width:360px;min-width:260px;display:flex;flex-direction:column;background:var(--bg1);flex-shrink:0;}
    .resize-handle{width:6px;cursor:col-resize;background:var(--line);flex-shrink:0;transition:background .15s;}
    .resize-handle:hover,.resize-handle.dragging{background:var(--cyan);}
    .pane-label{height:32px;display:flex;align-items:center;padding:0 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);border-bottom:1px solid var(--line);gap:7px;}
    .pane-label::before{content:'';width:5px;height:5px;border-radius:50%;background:var(--cyan);opacity:.55;}

    #code{flex:1;background:var(--bg0);color:var(--code);border:none;outline:none;
      font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.72;
      padding:12px 14px;resize:none;tab-size:2;caret-color:var(--cyan);}
    #code::selection{background:#4d9de030;}

    .syntax-ref{border-top:1px solid var(--line);padding:9px 14px;flex-shrink:0;}
    .syntax-ref h4{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-bottom:7px;}
    .syn-row{font-size:10.5px;line-height:1.9;font-family:'JetBrains Mono',monospace;color:var(--dim2);}
    .syn-row .k{color:var(--blue);}
    .syn-row .v{color:var(--amber);}
    .syn-row .c{color:var(--dim);font-style:italic;}

    .editor-footer{height:28px;border-top:1px solid var(--line);display:flex;align-items:center;padding:0 14px;gap:12px;flex-shrink:0;
      font-family:'JetBrains Mono',monospace;font-size:10.5px;color:var(--dim);}
    #stat-boards{color:var(--green);font-weight:600;}

    /* ‚îÄ‚îÄ PREVIEW SIDE ‚îÄ‚îÄ */
    .preview-side{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

    .tabs{height:32px;background:var(--bg1);border-bottom:1px solid var(--line);display:flex;flex-shrink:0;}
    .tab{display:flex;align-items:center;gap:6px;padding:0 18px;font-size:11px;font-weight:600;cursor:pointer;color:var(--dim);border-bottom:2px solid transparent;transition:all .15s;user-select:none;letter-spacing:.2px;}
    .tab:hover{color:var(--text);}
    .tab.active{color:var(--cyan);border-bottom-color:var(--cyan);}

    /* 2D sub-toolbar */
    .sub-toolbar{height:34px;background:var(--bg2);border-bottom:1px solid var(--line);display:flex;align-items:center;padding:0 12px;gap:8px;flex-shrink:0;}
    .view-btn{display:flex;align-items:center;gap:5px;font-size:10.5px;font-weight:600;padding:4px 10px;border-radius:4px;border:1px solid var(--line);background:transparent;color:var(--dim);cursor:pointer;transition:all .15s;letter-spacing:.2px;}
    .view-btn:hover{color:var(--text);border-color:var(--line2);}
    .view-btn.active{background:var(--bg3);border-color:var(--cyan);color:var(--cyan);}
    .sub-sep{width:1px;height:20px;background:var(--line);margin:0 4px;}
    .sort-label{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.8px;margin-left:4px;}
    .sort-btn{font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 8px;border-radius:3px;border:1px solid var(--line);background:transparent;color:var(--dim);cursor:pointer;transition:all .15s;}
    .sort-btn:hover{color:var(--text);}
    .sort-btn.active{color:var(--amber);border-color:var(--amber);}

    /* views */
    .view{flex:1;display:none;overflow:hidden;position:relative;}
    .view.active{display:flex;flex-direction:column;}

    /* 2D assembled */
    #view-2d-assemble{flex:1;overflow:hidden;}
    #svg2d{width:100%;height:100%;}

    /* 2D list */
    #view-2d-list{flex:1;display:flex;overflow:hidden;}
    .list-sidebar{width:190px;min-width:150px;border-right:1px solid var(--line);background:var(--bg1);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
    .sidebar-header{height:32px;display:flex;align-items:center;padding:0 12px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);border-bottom:1px solid var(--line);gap:8px;}
    .sidebar-actions{display:flex;gap:5px;margin-left:auto;}
    .sidebar-action{font-size:9px;color:var(--dim);cursor:pointer;padding:2px 6px;border-radius:3px;border:1px solid var(--line);background:transparent;transition:all .15s;}
    .sidebar-action:hover{color:var(--cyan);border-color:var(--cyan);}
    .board-list{flex:1;overflow-y:auto;padding:6px;}
    .board-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:5px;cursor:pointer;transition:background .12s;border:1px solid transparent;margin-bottom:2px;}
    .board-item:hover{background:var(--bg3);}
    .board-item.selected{background:var(--bg3);border-color:var(--line2);}
    .board-item.hidden-board{opacity:.38;}
    .board-color{width:9px;height:9px;border-radius:2px;flex-shrink:0;}
    .board-info{flex:1;min-width:0;}
    .board-name{font-size:11px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .board-id{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);}
    .board-toggle{width:16px;height:16px;border-radius:3px;border:1px solid var(--line2);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .12s;}
    .board-toggle.on{background:var(--cyan);border-color:var(--cyan);}
    .board-toggle.on::after{content:'‚úì';font-size:9px;color:#000;}

    /* Main list canvas */
    .list-canvas{flex:1;overflow:auto;background:var(--bg0);}
    #svg-list{display:block;}

    /* 3D view */
    #view-3d{flex:1;}
    #canvas3d{width:100%;height:100%;display:block;cursor:grab;}
    #canvas3d:active{cursor:grabbing;}
    .hint-3d{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--dim);background:#07111acc;backdrop-filter:blur(4px);padding:4px 14px;border-radius:20px;border:1px solid var(--line);pointer-events:none;white-space:nowrap;}

    .error-bar{display:none;background:#150a0a;border-top:1px solid #3d1010;color:#e08080;padding:5px 14px;font-size:10.5px;font-family:'JetBrains Mono',monospace;flex-shrink:0;}
  </style>
</head>
<body>

<header>
  <div class="logo">Draft<em>Maid</em></div>
  <span class="badge">v0.2</span>
  <select id="example-select">
    <option value="">‚Äî P≈ô√≠klady ‚Äî</option>
  </select>
  <div class="hdr-stats">
    <span class="hdr-stat">Desky: <b id="hdr-count">0</b></span>
    <span class="hdr-stat">Plocha: <b id="hdr-area">‚Äî</b></span>
    <span class="hdr-stat">Promƒõnn√©: <b id="hdr-vars">0</b></span>
  </div>
</header>

<div class="workspace">

  <!-- ‚îÄ‚îÄ EDITOR ‚îÄ‚îÄ -->
  <div class="editor-side">
    <div class="pane-label">DSL Editor</div>
    <textarea id="code" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
    <div class="syntax-ref">
      <h4>Syntaxe</h4>
      <div class="syn-row"><span class="k">$n√°zev</span> = <span class="v">hodnota</span> &nbsp;<span class="c"># promƒõnn√°</span></div>
      <div class="syn-row"><span class="k">board</span>[<span class="v">id</span>] <span class="v">≈† x V x H</span> <span class="k">"n√°zev"</span></div>
      <div class="syn-row">&nbsp;&nbsp; at <span class="v">X, Y, Z</span> &nbsp;<span class="c"># voliteln√©</span></div>
      <div class="syn-row">&nbsp;&nbsp; from <span class="v">X1,Y1</span> to <span class="v">X2,Y2</span> [z <span class="v">Z</span>]</div>
      <div class="syn-row">&nbsp;&nbsp; cut <span class="v">left V right V</span> &nbsp;<span class="c"># o≈ôez</span></div>
      <div class="syn-row">&nbsp;&nbsp; view <span class="v">f|s|t|fs|ft|st|fst</span> &nbsp;<span class="c"># pohled(y)</span></div>
      <div class="syn-row">&nbsp;&nbsp; color <span class="v">#hex</span> &nbsp;<span class="c"># voliteln√© (automatick√©)</span></div>
      <div class="syn-row" style="margin-top:4px;"><span class="c"># V√Ωrazy: $var, {id.top}, LEN(x1,y1,x2,y2)</span></div>
      <div class="syn-row"><span class="c"># Vlastnosti: .x .y .z .right .top .back .w .h .d .angle .x2 .y2</span></div>
    </div>
    <div class="editor-footer">
      <span id="stat-boards">0 desek</span>
      <span id="stat-area"></span>
      <span id="stat-vars"></span>
    </div>
  </div>

  <div class="resize-handle" id="resize-handle"></div>

  <!-- ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ -->
  <div class="preview-side">
    <div class="tabs">
      <div class="tab active" data-tab="2d">‚ó´ &nbsp;2D pohled</div>
      <div class="tab" data-tab="3d">‚óà &nbsp;3D n√°hled</div>
    </div>

    <!-- 2D view container -->
    <div class="view active" id="view-2d">
      <div class="sub-toolbar">
        <button class="view-btn active" id="btn-assemble">‚¨õ Sestaveno</button>
        <button class="view-btn" id="btn-list">‚â° Seznam desek</button>
        <div class="sub-sep" id="proj-sep"></div>
        <button class="sort-btn active" id="proj-front" data-proj="front">P≈ôedn√≠</button>
        <button class="sort-btn" id="proj-back" data-proj="back">Zadn√≠</button>
        <button class="sort-btn" id="proj-left" data-proj="left">Lev√Ω</button>
        <button class="sort-btn" id="proj-right" data-proj="right">Prav√Ω</button>
        <button class="sort-btn" id="proj-top" data-proj="top">Horn√≠</button>
        <button class="sort-btn" id="proj-bottom" data-proj="bottom">Spodn√≠</button>
        <div class="sub-sep" id="sort-sep" style="display:none;"></div>
        <span class="sort-label" id="sort-lbl" style="display:none;">≈òadit:</span>
        <button class="sort-btn active" id="sort-name" style="display:none;" data-sort="name">N√°zev</button>
        <button class="sort-btn" id="sort-w" style="display:none;" data-sort="w">≈†√≠≈ôka ‚Üì</button>
        <button class="sort-btn" id="sort-h" style="display:none;" data-sort="h">V√Ω≈°ka ‚Üì</button>
        <button class="sort-btn" id="sort-area" style="display:none;" data-sort="area">Plocha ‚Üì</button>
      </div>

      <!-- Assembled -->
      <div id="view-2d-assemble" class="active" style="display:block;flex:1;overflow:hidden;">
        <svg id="svg2d" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>

      <!-- List -->
      <div id="view-2d-list" style="display:none;flex:1;">
        <div class="list-sidebar">
          <div class="sidebar-header">
            Desky
            <div class="sidebar-actions">
              <button class="sidebar-action" id="btn-all">V≈°e</button>
              <button class="sidebar-action" id="btn-none">≈Ω√°dn√©</button>
            </div>
          </div>
          <div class="board-list" id="board-list-el"></div>
        </div>
        <div class="list-canvas" id="list-canvas-wrap">
          <svg id="svg-list" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
    </div>

    <!-- 3D view -->
    <div class="view" id="view-3d">
      <canvas id="canvas3d"></canvas>
      <div class="hint-3d">üñ± Ta≈æen√≠m rotuj ¬∑ Koleƒçkem p≈ôibli≈æ</div>
    </div>

    <div class="error-bar" id="error-bar"></div>
  </div>
</div>

<script>
function svgEl(tag, attrs={}, text='') {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (const [k,v] of Object.entries(attrs)) el.setAttribute(k,v);
  if (text) el.textContent = text;
  return el;
}
function saveToHash(text) {
  try { history.replaceState(null, '', '#code/' + encodeHash(text)); }
  catch(e) {}
}
function loadFromHash() {
  const h = window.location.hash;
  if (!h.startsWith('#code/')) return null;
  return decodeHash(h.slice(6));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  2D ASSEMBLED VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render2DAssemble(boards) {
  const svg = document.getElementById('svg2d');
  const W = svg.clientWidth||800, H = svg.clientHeight||600;
  svg.innerHTML = '';
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  svg.appendChild(svgEl('rect',{x:0,y:0,width:W,height:H,fill:'#070b0f'}));

  if (!boards.length) {
    svg.appendChild(svgEl('text',{x:W/2,y:H/2-8,fill:'#1c2b3d','text-anchor':'middle','font-size':40,'font-family':'monospace'},'‚ó´'));
    svg.appendChild(svgEl('text',{x:W/2,y:H/2+24,fill:'#1c3a5c','text-anchor':'middle','font-size':13,'font-family':'IBM Plex Sans,sans-serif'},'Napi≈°te desky...'));
    return;
  }

  const vis = boards.filter(b=>b.visible!==false);
  if (!vis.length) return;

  const proj = assembleProjection;
  const allPos = vis.every(b=>b.hasPos&&b.x!==null);
  let layout;
  if (allPos) {
    layout = vis.map(b=>{const p=projectBoard(b,proj); return {...b,...p};});
  } else {
    let cx=0; layout = vis.map(b=>{const p=projectBoard(b,proj); const l={...b,lx:cx,ly:0,lw:p.lw,lh:p.lh};cx+=p.lw+20;return l;});
  }

  // Compute AABB (accounting for rotation)
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  for (const b of layout) {
    const ang = b.angle || 0;
    if (ang !== 0 && (proj === 'front' || proj === 'back')) {
      // AABB for rotated board
      const rad = ang * Math.PI / 180;
      const cos = Math.cos(rad), sin = Math.sin(rad);
      const corners = [
        [b.lx, b.ly], [b.lx + b.lw*cos, b.ly + b.lw*sin],
        [b.lx + b.lw*cos - b.lh*sin, b.ly + b.lw*sin + b.lh*cos],
        [b.lx - b.lh*sin, b.ly + b.lh*cos]
      ];
      for (const c of corners) {
        minX=Math.min(minX,c[0]); minY=Math.min(minY,c[1]);
        maxX=Math.max(maxX,c[0]); maxY=Math.max(maxY,c[1]);
      }
    } else {
      minX=Math.min(minX,b.lx); minY=Math.min(minY,b.ly);
      maxX=Math.max(maxX,b.lx+b.lw); maxY=Math.max(maxY,b.ly+b.lh);
    }
  }

  const PAD=70;
  const scale=Math.min((W-PAD*2)/(maxX-minX||1),(H-PAD*2)/(maxY-minY||1))*0.86;
  const tw=(maxX-minX)*scale, th=(maxY-minY)*scale;
  const offX=(W-tw)/2-minX*scale, offY=(H-th)/2;

  const tx=wx=>wx*scale+offX;
  const ty=wy=>(maxY-wy)*scale+offY;

  // Grid
  for (let gx=0;gx<=W;gx+=40) svg.appendChild(svgEl('line',{x1:gx,y1:0,x2:gx,y2:H,stroke:'#1c2b3d','stroke-width':.5}));
  for (let gy=0;gy<=H;gy+=40) svg.appendChild(svgEl('line',{x1:0,y1:gy,x2:W,y2:gy,stroke:'#1c2b3d','stroke-width':.5}));

  // Helper: draw a board (rect or polygon) with grain, labels, dims into parent element
  function drawBoard(parent, b, ox, oy, bw, bh, dimParent, dimOx, dimOy) {
    const cut = hasCuts(b);
    if (cut) {
      // Polygon (SVG Y is already flipped by caller via oy)
      const pts = boardShape(b);
      const scx = bw / b.w, sch = bh / b.h;
      // Shadow polygon
      const shadowPts = pts.map(p=>`${ox+p[0]*scx+3},${oy+(b.h-p[1])*sch+3}`).join(' ');
      parent.appendChild(svgEl('polygon',{points:shadowPts,fill:'#00000044'}));
      // Main polygon
      const mainPts = pts.map(p=>`${ox+p[0]*scx},${oy+(b.h-p[1])*sch}`).join(' ');
      parent.appendChild(svgEl('polygon',{points:mainPts,fill:b.color,stroke:darken(b.color,.45),'stroke-width':1}));
    } else {
      parent.appendChild(svgEl('rect',{x:ox+3,y:oy+3,width:bw,height:bh,fill:'#00000044',rx:2}));
      parent.appendChild(svgEl('rect',{x:ox,y:oy,width:bw,height:bh,fill:b.color,stroke:darken(b.color,.45),'stroke-width':1,rx:2}));
    }
    // grain
    const gc=Math.min(6,Math.floor(bw/25));
    for(let i=1;i<=gc;i++){
      const gx=ox+(bw/(gc+1))*i;
      parent.appendChild(svgEl('line',{x1:gx,y1:oy+2,x2:gx,y2:oy+bh-2,stroke:'#ffffff0f','stroke-width':.8}));
    }
    // text
    const fs=Math.max(8,Math.min(11,bw/Math.max(b.name.length,3)*1.3));
    if (bw>24&&bh>14) {
      parent.appendChild(svgEl('text',{x:ox+bw/2,y:oy+bh/2-(bh>28?fs*.45:0),fill:'#ffffffcc','text-anchor':'middle','dominant-baseline':'middle','font-size':fs,'font-family':'IBM Plex Sans,sans-serif','font-weight':'600'},b.name));
    }
    if (bh>28&&bw>36) {
      parent.appendChild(svgEl('text',{x:ox+bw/2,y:oy+bh/2+fs*.85,fill:'#ffffff55','text-anchor':'middle','dominant-baseline':'middle','font-size':Math.max(7,fs-2.5),'font-family':'JetBrains Mono,monospace'},`[${b.id}]`));
    }
    if (bw>28) drawDimH(dimParent,dimOx,dimOx+bw,dimOy+bh+11,`${b.lw}`);
    if (bh>16) drawDimV(dimParent,dimOx-11,dimOy,dimOy+bh,`${b.lh}`);
  }

  for (const b of layout) {
    const ang = b.angle || 0;
    const rotated = ang !== 0 && (proj === 'front' || proj === 'back');
    const bx=tx(b.lx), bw=b.lw*scale, bh=b.lh*scale;

    if (rotated) {
      const by=ty(b.ly);
      const svgAng = -ang;
      const g = svgEl('g',{transform:`rotate(${svgAng},${bx},${by})`});
      drawBoard(g, b, bx, by, bw, bh, svg, bx, by);
      svg.appendChild(g);
    } else {
      const byFlip=ty(b.ly+b.lh);
      drawBoard(svg, b, bx, byFlip, bw, bh, svg, bx, byFlip);
    }
  }

  // Axis labels
  const [axH,axV] = projAxisLabels(proj);
  svg.appendChild(svgEl('text',{fill:'#4e6880','font-size':9,'font-family':'JetBrains Mono,monospace',x:W-10,y:H/2,'text-anchor':'end'},axH));
  svg.appendChild(svgEl('text',{fill:'#4e6880','font-size':9,'font-family':'JetBrains Mono,monospace',x:8,y:14},axV));
}

function drawDimH(svg,x1,x2,y,lbl){
  svg.appendChild(svgEl('line',{x1,y1:y,x2,y2:y,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('line',{x1,y1:y-3,x2:x1,y2:y+3,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('line',{x1:x2,y1:y-3,x2,y2:y+3,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('text',{x:(x1+x2)/2,y:y+10,fill:'#4a9cdcaa','text-anchor':'middle','font-size':8,'font-family':'JetBrains Mono,monospace'},lbl));
}
function drawDimV(svg,x,y1,y2,lbl){
  svg.appendChild(svgEl('line',{x1:x,y1,x2:x,y2,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('line',{x1:x-3,y1,x2:x+3,y2:y1,stroke:'#4a9cdc55','stroke-width':.8}));
  svg.appendChild(svgEl('line',{x1:x-3,y1:y2,x2:x+3,y2,stroke:'#4a9cdc55','stroke-width':.8}));
  const mid=(y1+y2)/2;
  const t=svgEl('text',{x:x-2,y:mid,fill:'#4a9cdcaa','text-anchor':'middle','font-size':8,'font-family':'JetBrains Mono,monospace',transform:`rotate(-90,${x-2},${mid})`},lbl);
  svg.appendChild(t);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  2D LIST VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedBoardId = null;
let sortMode = 'name';
let boardVisibility = {}; // id -> bool

function renderBoardSidebar(boards) {
  const el = document.getElementById('board-list-el');
  el.innerHTML = '';
  let sorted = [...boards];
  if (sortMode==='name')  sorted.sort((a,b)=>a.name.localeCompare(b.name));
  if (sortMode==='w')     sorted.sort((a,b)=>b.w-a.w);
  if (sortMode==='h')     sorted.sort((a,b)=>b.h-a.h);
  if (sortMode==='area')  sorted.sort((a,b)=>(b.w*b.h)-(a.w*a.h));

  for (const b of sorted) {
    const vis = boardVisibility[b.id] !== false;
    const item = document.createElement('div');
    item.className = 'board-item' + (b.id===selectedBoardId?' selected':'') + (!vis?' hidden-board':'');
    item.dataset.id = b.id;

    const colorDot = document.createElement('div');
    colorDot.className = 'board-color';
    colorDot.style.background = b.color;

    const info = document.createElement('div');
    info.className = 'board-info';
    info.innerHTML = `<div class="board-name">${b.name}</div><div class="board-id">[${b.id}] &nbsp;${b.w}√ó${b.h}√ó${b.d}</div>`;

    const toggle = document.createElement('div');
    toggle.className = 'board-toggle' + (vis?' on':'');
    toggle.onclick = (e) => {
      e.stopPropagation();
      boardVisibility[b.id] = !vis;
      renderListView(window._lastBoards);
    };

    item.onclick = () => {
      selectedBoardId = b.id;
      renderListView(window._lastBoards);
      scrollToBoard(b.id);
    };

    item.appendChild(colorDot);
    item.appendChild(info);
    item.appendChild(toggle);
    el.appendChild(item);
  }
}

function scrollToBoard(id) {
  const el = document.getElementById('card-'+id);
  if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
}

function renderListSVG(boards) {
  const svg = document.getElementById('svg-list');
  const container = document.getElementById('list-canvas-wrap');
  const CW = container.clientWidth || 600;

  svg.innerHTML = '';

  const visible = boards.filter(b => boardVisibility[b.id] !== false);
  let sorted = [...visible];
  if (sortMode==='name')  sorted.sort((a,b)=>a.name.localeCompare(b.name));
  if (sortMode==='w')     sorted.sort((a,b)=>b.w-a.w);
  if (sortMode==='h')     sorted.sort((a,b)=>b.h-a.h);
  if (sortMode==='area')  sorted.sort((a,b)=>(b.w*b.h)-(a.w*a.h));

  if (!sorted.length) {
    svg.setAttribute('width', CW); svg.setAttribute('height', 200);
    svg.appendChild(svgEl('text',{x:CW/2,y:100,fill:'#1c3a5c','text-anchor':'middle','font-size':13,'font-family':'IBM Plex Sans,sans-serif'},'≈Ω√°dn√© viditeln√© desky'));
    return;
  }

  const ROW_H = 140;
  const PAD_X = 80;
  const PAD_Y_TOP = 20;
  const VIEW_GAP = 12;

  // Available width for board drawing area
  const availW = CW - PAD_X * 2 - 180; // 180 for info on right
  const availH = ROW_H - 36;

  const totalSVGH = PAD_Y_TOP + sorted.length * (ROW_H + 4) + 20;
  svg.setAttribute('width', CW);
  svg.setAttribute('height', totalSVGH);
  svg.appendChild(svgEl('rect',{x:0,y:0,width:CW,height:totalSVGH,fill:'#070b0f'}));

  for (let i=0; i<sorted.length; i++) {
    const b = sorted[i];
    const ry = PAD_Y_TOP + i*(ROW_H+4);
    const isSelected = b.id === selectedBoardId;

    // Row bg
    svg.appendChild(svgEl('rect',{x:8,y:ry,width:CW-16,height:ROW_H,fill:isSelected?'#0e1e2e':'#0b1520',rx:6,
      stroke:isSelected?'#253547':'#111e2c','stroke-width':1}));

    // Board number label
    svg.appendChild(svgEl('text',{x:18,y:ry+18,fill:'#253547','font-size':10,'font-family':'JetBrains Mono,monospace',
      'font-weight':'600'},(i+1).toString().padStart(2,'0')));

    // --- Multi-view: get views for this board ---
    const views = listViewDimsMulti(b);
    const isMulti = views.length > 1;

    // Compute total natural width of all views (for proportional slot allocation)
    const totalGaps = (views.length - 1) * VIEW_GAP;
    const slotAvailW = availW - totalGaps;

    // Scale each view independently but within its proportional slot
    const totalNatW = views.reduce((s, v) => s + v.dw, 0);
    const viewLayouts = [];
    let curX = PAD_X;

    for (let vi = 0; vi < views.length; vi++) {
      const vd = views[vi];
      // Each view gets a proportional share of the available width
      const slotW = (vd.dw / totalNatW) * slotAvailW;
      const scaleX = slotW / vd.dw;
      const scaleH = availH / vd.dh;
      const bscale = Math.min(scaleX, scaleH, 0.5);

      const bw = vd.dw * bscale;
      const bh = vd.dh * bscale;

      const bx = curX + (slotW - bw) / 2;
      const by = ry + (ROW_H - bh) / 2;

      viewLayouts.push({ vd, bx, by, bw, bh, slotX: curX, slotW });
      curX += slotW + VIEW_GAP;
    }

    // Draw each view
    for (let vi = 0; vi < views.length; vi++) {
      const vd = views[vi];
      const { bx, by, bw, bh } = viewLayouts[vi];
      const isFirst = vi === 0;

      // Shadow + Board (polygon for cuts only on front view)
      if (hasCuts(b) && vd.view === 'f') {
        const pts = boardShape(b);
        const scx = bw / vd.dw, sch = bh / vd.dh;
        const shadowPts = pts.map(p=>`${bx+p[0]*scx+3},${by+(b.h-p[1])*sch+3}`).join(' ');
        svg.appendChild(svgEl('polygon',{points:shadowPts,fill:'#00000044'}));
        const mainPts = pts.map(p=>`${bx+p[0]*scx},${by+(b.h-p[1])*sch}`).join(' ');
        const attrs = {points:mainPts,fill:b.color,stroke:darken(b.color,.4),'stroke-width':1};
        if (isFirst) attrs.id = 'card-'+b.id;
        svg.appendChild(svgEl('polygon',attrs));
      } else {
        svg.appendChild(svgEl('rect',{x:bx+3,y:by+3,width:bw,height:bh,fill:'#00000044',rx:2}));
        const attrs = {x:bx,y:by,width:bw,height:bh,fill:b.color,stroke:darken(b.color,.4),'stroke-width':1,rx:2};
        if (isFirst) attrs.id = 'card-'+b.id;
        svg.appendChild(svgEl('rect',attrs));
      }

      // Grain
      const gc=Math.min(7,Math.floor(bw/20));
      for(let g=1;g<=gc;g++){
        const gx=bx+(bw/(gc+1))*g;
        svg.appendChild(svgEl('line',{x1:gx,y1:by+2,x2:gx,y2:by+bh-2,stroke:'#ffffff0e','stroke-width':.7}));
      }

      // Width dim (below each view)
      const dimY = by+bh+10;
      svg.appendChild(svgEl('line',{x1:bx,y1:dimY,x2:bx+bw,y2:dimY,stroke:'#4a9cdc44','stroke-width':.8}));
      svg.appendChild(svgEl('line',{x1:bx,y1:dimY-3,x2:bx,y2:dimY+3,stroke:'#4a9cdc44','stroke-width':.8}));
      svg.appendChild(svgEl('line',{x1:bx+bw,y1:dimY-3,x2:bx+bw,y2:dimY+3,stroke:'#4a9cdc44','stroke-width':.8}));
      svg.appendChild(svgEl('text',{x:bx+bw/2,y:dimY+10,fill:'#4a9cdc99','text-anchor':'middle','font-size':8.5,'font-family':'JetBrains Mono,monospace'},`${vd.dw} mm`));

      // Height dim (left) ‚Äî only on first view
      if (isFirst) {
        const dimX = bx - 10;
        svg.appendChild(svgEl('line',{x1:dimX,y1:by,x2:dimX,y2:by+bh,stroke:'#4a9cdc44','stroke-width':.8}));
        svg.appendChild(svgEl('line',{x1:dimX-3,y1:by,x2:dimX+3,y2:by,stroke:'#4a9cdc44','stroke-width':.8}));
        svg.appendChild(svgEl('line',{x1:dimX-3,y1:by+bh,x2:dimX+3,y2:by+bh,stroke:'#4a9cdc44','stroke-width':.8}));
        const midY=by+bh/2;
        svg.appendChild(svgEl('text',{x:dimX-3,y:midY,fill:'#4a9cdc99','text-anchor':'middle','font-size':8.5,'font-family':'JetBrains Mono,monospace',transform:`rotate(-90,${dimX-3},${midY})`},`${vd.dh} mm`));
      }

      // View label (only in multi-view mode)
      if (isMulti) {
        svg.appendChild(svgEl('text',{x:bx+bw/2,y:by-6,fill:'#4e688099','text-anchor':'middle','font-size':8,'font-family':'JetBrains Mono,monospace','class':'view-label'},vd.label));
      }
    }

    // --- Info panel (right) at fixed position ---
    const ix = CW - 180 + 8;
    const iy = ry + 22;
    // Name
    svg.appendChild(svgEl('text',{x:ix,y:iy,fill:'#c8d8e8','font-size':13,'font-family':'IBM Plex Sans,sans-serif','font-weight':'600'},b.name));
    // ID
    svg.appendChild(svgEl('text',{x:ix,y:iy+18,fill:'#4e6880','font-size':10,'font-family':'JetBrains Mono,monospace'},`[${b.id}]`));
    // Dims
    svg.appendChild(svgEl('text',{x:ix,y:iy+38,fill:'#8fa8c0','font-size':10.5,'font-family':'JetBrains Mono,monospace'},`≈†: ${b.w} mm`));
    svg.appendChild(svgEl('text',{x:ix,y:iy+54,fill:'#8fa8c0','font-size':10.5,'font-family':'JetBrains Mono,monospace'},`V: ${b.h} mm`));
    svg.appendChild(svgEl('text',{x:ix,y:iy+70,fill:'#8fa8c0','font-size':10.5,'font-family':'JetBrains Mono,monospace'},`H: ${b.d} mm`));
    // Area (front face)
    const vd0 = views[0];
    const area = (vd0.dw * vd0.dh / 1e6).toFixed(4);
    svg.appendChild(svgEl('text',{x:ix,y:iy+88,fill:'#f0a02099','font-size':10,'font-family':'JetBrains Mono,monospace'},`${area} m¬≤`));

    // View indicator (if not default single front)
    let infoY = iy + 106;
    if (b.view && b.view !== 'f') {
      const viewLabels = [...b.view].map(ch => VIEW_LABELS[ch] || ch).join(' + ');
      svg.appendChild(svgEl('text',{x:ix,y:infoY,fill:'#8b6fe877','font-size':9.5,'font-family':'JetBrains Mono,monospace'},`pohled: ${viewLabels}`));
      infoY += 16;
    }

    // Cuts info
    if (hasCuts(b)) {
      const cutParts = [];
      if (b.cuts.left!==null) cutParts.push(`L:${b.cuts.left}`);
      if (b.cuts.right!==null) cutParts.push(`R:${b.cuts.right}`);
      if (b.cuts.top!==null) cutParts.push(`T:${b.cuts.top}`);
      if (b.cuts.bottom!==null) cutParts.push(`B:${b.cuts.bottom}`);
      svg.appendChild(svgEl('text',{x:ix,y:infoY,fill:'#d9505077','font-size':9.5,'font-family':'JetBrains Mono,monospace'},`o≈ôez: ${cutParts.join(' ')}`));
      infoY += 16;
    }

    // Angle info
    if (b.angle && b.angle !== 0) {
      svg.appendChild(svgEl('text',{x:ix,y:infoY,fill:'#8b6fe877','font-size':9.5,'font-family':'JetBrains Mono,monospace'},`√∫hel: ${Math.round(b.angle*10)/10}¬∞`));
      infoY += 16;
    }

    // Position (if set)
    if (b.hasPos) {
      svg.appendChild(svgEl('text',{x:ix,y:infoY,fill:'#38c46e77','font-size':9.5,'font-family':'JetBrains Mono,monospace'},`at (${b.x}, ${b.y}, ${b.z})`));
    }
  }
}

function renderListView(boards) {
  renderBoardSidebar(boards);
  renderListSVG(boards);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  3D RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let scene3,cam3,ren3,grp3,initialized3=false;
let camT=0.7,camP=0.5,camR=4000,camTarget=new THREE.Vector3();
let mDrag=false,mPrev={x:0,y:0};

function init3D(){
  const canvas=document.getElementById('canvas3d');
  const W=canvas.offsetWidth||800,H=canvas.offsetHeight||600;
  scene3=new THREE.Scene();
  scene3.background=new THREE.Color(0x070b0f);
  scene3.fog=new THREE.FogExp2(0x070b0f,0.00007);
  cam3=new THREE.PerspectiveCamera(40,W/H,1,80000);
  updateCam3();
  ren3=new THREE.WebGLRenderer({canvas,antialias:true});
  ren3.setSize(W,H); ren3.setPixelRatio(Math.min(window.devicePixelRatio,2));
  ren3.shadowMap.enabled=true; ren3.shadowMap.type=THREE.PCFSoftShadowMap;

  scene3.add(new THREE.AmbientLight(0x506070,0.9));
  const sun=new THREE.DirectionalLight(0xfff5e0,1.1);
  sun.position.set(3000,5000,2000); sun.castShadow=true;
  sun.shadow.mapSize.width=sun.shadow.mapSize.height=2048;
  ['left','right','top','bottom'].forEach(s=>sun.shadow.camera[s]=s==='top'||s==='right'?4000:-4000);
  sun.shadow.camera.near=10; sun.shadow.camera.far=20000;
  scene3.add(sun);
  const fill=new THREE.DirectionalLight(0x304870,0.4); fill.position.set(-2000,800,-1500); scene3.add(fill);

  const grid=new THREE.GridHelper(8000,40,0x1c2b3d,0x111825);
  grid.position.y=-1; scene3.add(grid);
  const gnd=new THREE.Mesh(new THREE.PlaneGeometry(10000,10000),new THREE.ShadowMaterial({opacity:.18}));
  gnd.rotation.x=-Math.PI/2; gnd.receiveShadow=true; scene3.add(gnd);

  grp3=new THREE.Group(); scene3.add(grp3);
  scene3.add(new THREE.AxesHelper(150));

  canvas.addEventListener('mousedown',e=>{mDrag=true;mPrev={x:e.clientX,y:e.clientY};});
  window.addEventListener('mouseup',()=>mDrag=false);
  canvas.addEventListener('mousemove',e=>{
    if(!mDrag)return;
    camT-=(e.clientX-mPrev.x)*0.008;
    camP=Math.max(0.05,Math.min(1.52,camP-(e.clientY-mPrev.y)*0.007));
    mPrev={x:e.clientX,y:e.clientY}; updateCam3();
  });
  canvas.addEventListener('wheel',e=>{
    camR=Math.max(200,Math.min(25000,camR*(1+e.deltaY*0.001)));
    updateCam3(); e.preventDefault();
  },{passive:false});

  initialized3=true;
  (function loop(){requestAnimationFrame(loop);ren3.render(scene3,cam3);})();
}

function updateCam3(){
  const x=camR*Math.sin(camP)*Math.sin(camT);
  const y=camR*Math.cos(camP);
  const z=camR*Math.sin(camP)*Math.cos(camT);
  cam3.position.set(camTarget.x+x,camTarget.y+y,camTarget.z+z);
  cam3.lookAt(camTarget);
}

function render3D(boards){
  if(!grp3)return;
  while(grp3.children.length){const c=grp3.children[0];c.geometry?.dispose();c.material?.dispose();grp3.remove(c);}
  if(!boards.length)return;

  const allPos=boards.every(b=>b.hasPos&&b.x!==null);
  let ax=0;
  let cx=0,cy=0,cz=0,maxDim=0;

  for(const b of boards){
    let bx=allPos?(b.x??0):ax;
    let by=allPos?(b.y??0):0;
    let bz=allPos?(b.z??0):0;
    if(!allPos) ax+=b.w+20;

    const ang = b.angle || 0;
    const hasCut = b.cuts && (b.cuts.left!==null||b.cuts.right!==null||b.cuts.top!==null||b.cuts.bottom!==null);

    let geo, mesh;
    let col;
    try{col=new THREE.Color(b.color);}catch{col=new THREE.Color(0xb08050);}

    if (hasCut) {
      // Extruded shape for cut boards
      const pts = boardShape(b);
      const shape = new THREE.Shape();
      shape.moveTo(pts[0][0]-b.w/2, pts[0][1]-b.h/2);
      for (let i=1; i<pts.length; i++) shape.lineTo(pts[i][0]-b.w/2, pts[i][1]-b.h/2);
      shape.closePath();
      geo = new THREE.ExtrudeGeometry(shape, { depth: b.d, bevelEnabled: false });
      mesh = new THREE.Mesh(geo, new THREE.MeshLambertMaterial({color:col}));
      mesh.position.set(bx+b.w/2, by+b.h/2, bz);
    } else {
      geo = new THREE.BoxGeometry(b.w,b.h,b.d);
      mesh = new THREE.Mesh(geo, new THREE.MeshLambertMaterial({color:col}));
      mesh.position.set(bx+b.w/2, by+b.h/2, bz+b.d/2);
    }

    if (ang !== 0) {
      // Rotate around origin point, not center
      const rad = ang * Math.PI / 180;
      const cos = Math.cos(rad), sin = Math.sin(rad);
      // Pivot is at (bx, by) - offset center from pivot
      const hw = b.w/2, hh = b.h/2;
      const rcx = hw*cos - hh*sin;
      const rcy = hw*sin + hh*cos;
      mesh.position.set(bx + rcx, by + rcy, bz + (hasCut ? 0 : b.d/2));
      mesh.rotation.z = rad;
    }

    mesh.castShadow=true; mesh.receiveShadow=true;
    const edgeMat=new THREE.LineBasicMaterial({color:new THREE.Color(b.color).multiplyScalar(0.35),transparent:true,opacity:.85});
    mesh.add(new THREE.LineSegments(new THREE.EdgesGeometry(geo),edgeMat));
    grp3.add(mesh);

    // AABB for camera bounds
    if (ang !== 0) {
      const rad2 = ang * Math.PI / 180;
      const cos2 = Math.cos(rad2), sin2 = Math.sin(rad2);
      const corners = [
        [bx, by], [bx + b.w*cos2, by + b.w*sin2],
        [bx + b.w*cos2 - b.h*sin2, by + b.w*sin2 + b.h*cos2],
        [bx - b.h*sin2, by + b.h*cos2]
      ];
      const xs = corners.map(c=>c[0]), ys = corners.map(c=>c[1]);
      cx+=(Math.min(...xs)+Math.max(...xs))/2;
      cy+=(Math.min(...ys)+Math.max(...ys))/2;
      cz+=bz+b.d/2;
      maxDim=Math.max(maxDim,Math.max(...xs),Math.max(...ys),bz+b.d);
    } else {
      cx+=bx+b.w/2; cy+=by+b.h/2; cz+=bz+b.d/2;
      maxDim=Math.max(maxDim,bx+b.w,by+b.h,bz+b.d);
    }
  }

  const n=boards.length;
  camTarget.set(cx/n,cy/n,cz/n);
  camR=maxDim*2.1;
  updateCam3();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTab='2d';
let current2DMode='assemble';
let assembleProjection='front';
let debTimer;

function update(){
  const text=document.getElementById('code').value;
  saveToHash(text);
  const {boards,errors,varCount}=parseDSL(text);
  window._lastBoards=boards;

  // Init visibility for new boards
  for(const b of boards) if(boardVisibility[b.id]===undefined) boardVisibility[b.id]=true;

  // Apply visibility
  const visBoards = boards.map(b=>({...b,visible:boardVisibility[b.id]!==false}));

  // Errors
  const eb=document.getElementById('error-bar');
  eb.style.display=errors.length?'block':'none';
  eb.textContent=errors.length?'‚ö†  '+errors.join('  ¬∑  '):'';

  // Stats
  const n=boards.length;
  const area=boards.reduce((s,b)=>s+b.w*b.h/1e6,0);
  document.getElementById('stat-boards').textContent=boardCount(n);
  document.getElementById('stat-area').textContent=area>0?area.toFixed(3)+' m¬≤':'';
  document.getElementById('stat-vars').textContent=varCount>0?`${varCount} var`:'';
  document.getElementById('hdr-count').textContent=n;
  document.getElementById('hdr-area').textContent=area>0?area.toFixed(3)+' m¬≤':'‚Äî';
  document.getElementById('hdr-vars').textContent=varCount;

  // Render
  if(currentTab==='2d'){
    if(current2DMode==='assemble') render2DAssemble(visBoards);
    else renderListView(boards);
  } else if(currentTab==='3d'&&initialized3){
    render3D(visBoards.filter(b=>b.visible!==false));
  }
}

function debouncedUpdate(){clearTimeout(debTimer);debTimer=setTimeout(update,220);}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    tab.classList.add('active');
    currentTab=tab.dataset.tab;
    document.getElementById(`view-${currentTab}`).classList.add('active');
    const {boards}=parseDSL(document.getElementById('code').value);
    window._lastBoards=boards;
    if(currentTab==='3d'){
      if(!initialized3) requestAnimationFrame(()=>{init3D();render3D(boards);});
      else render3D(boards);
    } else { requestAnimationFrame(()=>update()); }
  });
});

// ‚îÄ‚îÄ 2D SUB-TOOLBAR ‚îÄ‚îÄ
const projIds = ['proj-sep','proj-front','proj-back','proj-left','proj-right','proj-top','proj-bottom'];

document.getElementById('btn-assemble').addEventListener('click',()=>{
  current2DMode='assemble';
  document.getElementById('btn-assemble').classList.add('active');
  document.getElementById('btn-list').classList.remove('active');
  document.getElementById('view-2d-assemble').style.display='block';
  document.getElementById('view-2d-list').style.display='none';
  projIds.forEach(id=>{document.getElementById(id).style.display='';});
  ['sort-sep','sort-lbl','sort-name','sort-w','sort-h','sort-area'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
  update();
});

document.getElementById('btn-list').addEventListener('click',()=>{
  current2DMode='list';
  document.getElementById('btn-list').classList.add('active');
  document.getElementById('btn-assemble').classList.remove('active');
  document.getElementById('view-2d-assemble').style.display='none';
  document.getElementById('view-2d-list').style.display='flex';
  projIds.forEach(id=>{document.getElementById(id).style.display='none';});
  ['sort-sep','sort-lbl','sort-name','sort-w','sort-h','sort-area'].forEach(id=>{
    document.getElementById(id).style.display='';
  });
  update();
});

// Projection buttons
['proj-front','proj-back','proj-left','proj-right','proj-top','proj-bottom'].forEach(btnId=>{
  document.getElementById(btnId).addEventListener('click',()=>{
    assembleProjection=document.getElementById(btnId).dataset.proj;
    ['proj-front','proj-back','proj-left','proj-right','proj-top','proj-bottom'].forEach(id=>document.getElementById(id).classList.remove('active'));
    document.getElementById(btnId).classList.add('active');
    update();
  });
});

// Sort buttons
['sort-name','sort-w','sort-h','sort-area'].forEach(btnId=>{
  document.getElementById(btnId).addEventListener('click',()=>{
    sortMode=document.getElementById(btnId).dataset.sort;
    ['sort-name','sort-w','sort-h','sort-area'].forEach(id=>document.getElementById(id).classList.remove('active'));
    document.getElementById(btnId).classList.add('active');
    if(current2DMode==='list') renderListView(window._lastBoards||[]);
  });
});

// Sidebar all/none
document.getElementById('btn-all').addEventListener('click',()=>{
  (window._lastBoards||[]).forEach(b=>{boardVisibility[b.id]=true;});
  renderListView(window._lastBoards||[]);
});
document.getElementById('btn-none').addEventListener('click',()=>{
  (window._lastBoards||[]).forEach(b=>{boardVisibility[b.id]=false;});
  renderListView(window._lastBoards||[]);
});

// Resize
window.addEventListener('resize',()=>{
  if(currentTab==='2d'){
    const {boards}=parseDSL(document.getElementById('code').value);
    const vis=boards.map(b=>({...b,visible:boardVisibility[b.id]!==false}));
    if(current2DMode==='assemble') render2DAssemble(vis);
    else renderListSVG(boards);
  }
  if(initialized3&&ren3){
    const c=document.getElementById('canvas3d');
    if(c.offsetWidth>0){ren3.setSize(c.offsetWidth,c.offsetHeight);cam3.aspect=c.offsetWidth/c.offsetHeight;cam3.updateProjectionMatrix();}
  }
});

// ‚îÄ‚îÄ EXAMPLES DROPDOWN ‚îÄ‚îÄ
const exSelect = document.getElementById('example-select');
EXAMPLES.forEach((ex, i) => {
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = ex.name;
  exSelect.appendChild(opt);
});
exSelect.addEventListener('change', () => {
  const idx = exSelect.value;
  if (idx === '') return;
  document.getElementById('code').value = EXAMPLES[idx].code;
  update();
});
document.getElementById('code').addEventListener('input', () => {
  exSelect.value = '';
});

// ‚îÄ‚îÄ RESIZABLE PANELS ‚îÄ‚îÄ
(function(){
  const MIN_EDITOR = 260;
  const MIN_PREVIEW = 300;
  const handle = document.getElementById('resize-handle');
  const editor = document.querySelector('.editor-side');
  let dragging = false;

  function applyWidth(w) {
    const maxW = window.innerWidth - MIN_PREVIEW - handle.offsetWidth;
    const clamped = Math.max(MIN_EDITOR, Math.min(w, maxW));
    editor.style.width = clamped + 'px';
  }

  handle.addEventListener('mousedown', (e) => {
    dragging = true;
    handle.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  window.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    applyWidth(e.clientX - editor.getBoundingClientRect().left);
  });

  window.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    try { localStorage.setItem('draftmaid-editor-width', editor.offsetWidth); } catch(e) {}
    window.dispatchEvent(new Event('resize'));
  });

  // Restore saved width on load
  try {
    const saved = localStorage.getItem('draftmaid-editor-width');
    if (saved) applyWidth(Number(saved));
  } catch(e) {}
})();

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.getElementById('code').value=loadFromHash()||DEFAULT_CODE;
document.getElementById('code').addEventListener('input',debouncedUpdate);
update();
</script>
</body>
</html>
